<!-- blog/templates/blog/post_detail.html -->

<!DOCTYPE html>
<html>
<head>
    <title>{{ post.title }}</title>
</head>
<body>
    <h1>{{ post.title }}</h1>
    <p>
        {% if post.cover %}
            <img src="{{ post.cover.url }}" alt="–û–±–ª–æ–∂–∫–∞" style="width: 40%; max-height: 400px; object-fit: cover;">
        {% endif %}
    </p>
    <p><strong>–ê–≤—Ç–æ—Ä:</strong> {{ post.author.username }}</p>
    <p><strong>–ü—Ä–æ—Å–º–æ—Ç—Ä–æ–≤:</strong> {{ post.views }}</p>
    <p><strong>–õ–∞–π–∫–æ–≤:</strong> {{ post.total_likes }}</p>
    <hr>
    <p>{{ post.content }}</p>

    <!-- CSRF-—Ç–æ–∫–µ–Ω -->
    {% csrf_token %}

    <!-- –í—Ä–µ–º—è —á—Ç–µ–Ω–∏—è -->
    <script>
        const startTime = Date.now();

        // –ü–æ–ª—É—á–∏–º CSRF-—Ç–æ–∫–µ–Ω –∏–∑ cookie
        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }
        const csrftoken = getCookie('csrftoken');

        // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –≤—Ä–µ–º—è –Ω–∞ —Å–µ—Ä–≤–µ—Ä –ø—Ä–∏ —É—Ö–æ–¥–µ —Å–æ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        window.addEventListener('beforeunload', function () {
            const endTime = Date.now();
            const secondsSpent = Math.round((endTime - startTime) / 1000);

            if (secondsSpent > 5) { // –ù–µ –ª–æ–≥–∏—Ä—É–µ–º –µ—Å–ª–∏ –º–µ–Ω—å—à–µ 5 —Å–µ–∫—É–Ω–¥
                navigator.sendBeacon("/track-time/", JSON.stringify({
                    post_id: {{ post.id }},
                    seconds: secondsSpent
                }));
            }
        });

        // –î–ª—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏ (–µ—Å–ª–∏ –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç sendBeacon)
        window.addEventListener('unload', function () {
            const endTime = Date.now();
            const secondsSpent = Math.round((endTime - startTime) / 1000);

            if (secondsSpent > 5) {
                fetch("/track-time/", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                        "X-CSRFToken": csrftoken
                    },
                    body: JSON.stringify({
                        post_id: {{ post.id }},
                        seconds: secondsSpent
                    })
                });
            }
        });
    </script>
    <form method="post" action="">
        {% csrf_token %}
        {% if user.is_authenticated %}
            <button type="submit">
                {% if is_liked %}
                    üíî –£–±—Ä–∞—Ç—å –ª–∞–π–∫
                {% else %}
                    ‚ù§Ô∏è –õ–∞–π–∫–Ω—É—Ç—å
                {% endif %}
            </button>
        {% else %}
            <p><a href="{% url 'login' %}?next={{ request.path }}">–í–æ–π–¥–∏—Ç–µ</a>, —á—Ç–æ–±—ã –ø–æ—Å—Ç–∞–≤–∏—Ç—å –ª–∞–π–∫.</p>
        {% endif %}
    </form>
</body>
</html>
